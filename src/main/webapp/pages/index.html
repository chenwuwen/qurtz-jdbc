<%
layout("/layout/layout.html"){
%>
<link rel="stylesheet" href="${ctxPath}/assets/css/index.css" media="all">
<div class="layui-body" style="padding: 15px;background-color: #f2f2f2">

    <div class="layadmin-tabsbody-item layui-show">

        <div class="layui-fluid">
            <div class="layui-row layui-col-space15">


                <div class="layui-col-sm6 layui-col-md3">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            访问量
                            <span class="layui-badge layui-bg-blue layuiadmin-badge">周</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">
                            <p class="layuiadmin-big-font">9,999,666</p>
                            <p>
                                总计访问量
                                <span class="layuiadmin-span-color">88万 <i class="layui-icon"></i></span>
                            </p>
                        </div>
                    </div>
                </div>


                <div class="layui-col-sm6 layui-col-md3">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            下载
                            <span class="layui-badge layui-bg-cyan layuiadmin-badge">月</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">
                            <p class="layuiadmin-big-font">33,555</p>
                            <p>
                                新下载
                                <span class="layuiadmin-span-color">10% <i class="layui-icon"></i></span>
                            </p>
                        </div>
                    </div>
                </div>


                <div class="layui-col-sm6 layui-col-md3">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            收入
                            <span class="layui-badge layui-bg-green layuiadmin-badge">年</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">

                            <p class="layuiadmin-big-font">999,666</p>
                            <p>
                                总收入
                                <span class="layuiadmin-span-color">*** <i class="layui-icon"></i></span>
                            </p>
                        </div>
                    </div>
                </div>


                <div class="layui-col-sm6 layui-col-md3">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            活跃用户
                            <span class="layui-badge layui-bg-orange layuiadmin-badge">月</span>
                        </div>
                        <div class="layui-card-body layuiadmin-card-list">

                            <p class="layuiadmin-big-font">66,666</p>
                            <p>
                                最近一个月
                                <span class="layuiadmin-span-color">15% <i class="layui-icon"></i></span>
                            </p>
                        </div>
                    </div>
                </div>


                <div class="layui-col-sm12">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            访问量
                            <div class="layui-btn-group layuiadmin-btn-group">
                                <button class="layui-btn layui-btn-primary layui-btn-xs">去年</button>
                                <button class="layui-btn layui-btn-primary layui-btn-xs">今年</button>
                            </div>
                        </div>
                        <div class="layui-card-body">
                            <div class="layui-row">
                                <div class="layui-col-sm8">
                                    <div class="layui-carousel layadmin-carousel layadmin-dataview" data-anim="fade"
                                         lay-filter="LAY-index-pagetwo" lay-anim="fade"
                                         style="width: 100%; height: 280px;">
                                        <div carousel-item="" id="LAY-index-pagetwo">
                                            <div class="layui-this" _echarts_instance_="1578732407451"
                                                 style="-webkit-tap-highlight-color: transparent; user-select: none; background-color: rgba(0, 0, 0, 0); cursor: default;">
                                                <div style="position: relative; overflow: hidden; width: 655px; height: 332px;">
                                                    <div data-zr-dom-id="bg" class="zr-element"
                                                         style="position: absolute; left: 0px; top: 0px; width: 655px; height: 332px; user-select: none;"></div>
                                                    <canvas width="982" height="498" data-zr-dom-id="0"
                                                            class="zr-element"
                                                            style="position: absolute; left: 0px; top: 0px; width: 655px; height: 332px; user-select: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></canvas>
                                                    <canvas width="982" height="498" data-zr-dom-id="1"
                                                            class="zr-element"
                                                            style="position: absolute; left: 0px; top: 0px; width: 655px; height: 332px; user-select: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></canvas>
                                                    <canvas width="982" height="498" data-zr-dom-id="_zrender_hover_"
                                                            class="zr-element"
                                                            style="position: absolute; left: 0px; top: 0px; width: 655px; height: 332px; user-select: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-sm4">
                                    <div class="layuiadmin-card-list">
                                        <p class="layuiadmin-normal-font">月访问数</p>
                                        <span>同上期增长</span>
                                        <div class="layui-progress layui-progress-big" lay-showpercent="yes">
                                            <div class="layui-progress-bar" lay-percent="30%" style="width: 30%;"><span
                                                    class="layui-progress-text">30%</span></div>
                                        </div>
                                    </div>
                                    <div class="layuiadmin-card-list">
                                        <p class="layuiadmin-normal-font">月下载数</p>
                                        <span>同上期增长</span>
                                        <div class="layui-progress layui-progress-big" lay-showpercent="yes">
                                            <div class="layui-progress-bar" lay-percent="20%" style="width: 20%;"><span
                                                    class="layui-progress-text">20%</span></div>
                                        </div>
                                    </div>
                                    <div class="layuiadmin-card-list">
                                        <p class="layuiadmin-normal-font">月收入</p>
                                        <span>同上期增长</span>
                                        <div class="layui-progress layui-progress-big" lay-showpercent="yes">
                                            <div class="layui-progress-bar" lay-percent="25%" style="width: 25%;"><span
                                                    class="layui-progress-text">25%</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="layui-col-sm12">
                    <div class="layui-card">
                        <div class="layui-card-header">
                            日志输出
                            <div class="layui-btn-group layuiadmin-btn-group">
                                <button class="layui-btn layui-btn-primary layui-btn-xs" onClick="clearLog()">
                                    <i class="layui-icon layui-icon-delete"></i> 清空
                                </button>
                                <button class="layui-btn layui-btn-primary layui-btn-xs" onClick="downloadLog()">
                                    <i class="layui-icon layui-icon-download-circle"></i>下载
                                </button>
                            </div>
                        </div>
                        <div class="layui-card-body layui-bg-black">
                            <div id="web_log">
                                <i class="layui-icon layui-icon-screen-full" onclick="logFullScreen()"></i>
                                <div contenteditable="true" class="layui-bg-black log_container">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="layui-col-sm4">
                    <div class="layui-card">
                        <div class="layui-card-header">用户留言</div>
                        <div class="layui-card-body">
                            <ul class="layuiadmin-card-status layuiadmin-home2-usernote">
                                <li>
                                    <h3>贤心</h3>
                                    <p>作为 layui 官方推出的后台模板，从初版的饱受争议，到后续的埋头丰富，逐步占据了国内后台系统应用的主要市场。</p>
                                    <span>5月30日 00:00</span>
                                    <a href="javascript:;" layadmin-event="replyNote" data-id="7"
                                       class="layui-btn layui-btn-xs layuiadmin-reply">回复</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="layui-col-sm8">
                    <div class="layui-row layui-col-space15">
                        <div class="layui-col-sm6">
                            <div class="layui-card">
                                <div class="layui-card-header">本周活跃用户列表</div>
                                <div class="layui-card-body">
                                    <table class="layui-table layuiadmin-page-table" lay-skin="line">
                                        <thead>
                                        <tr>
                                            <th>用户名</th>
                                            <th>最后登录时间</th>
                                            <th>状态</th>
                                            <th>获得赞</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr>
                                            <td><span class="first">胡歌</span></td>
                                            <td><i class="layui-icon layui-icon-log"> 11:20</i></td>
                                            <td><span>在线</span></td>
                                            <td>22 <i class="layui-icon layui-icon-praise"></i></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="layui-col-sm6">

                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>


<% } %>

<script type="application/javascript">

    /**
     * 清空日志
     */
    function clearLog() {
        $("#web_log .log_container").html("")
    }

    /**
     * 下载日志
     * https://www.cnblogs.com/boluoboluo/p/6973283.html
     * https://blog.csdn.net/yangchun1213/article/details/7605497
     */
    function downloadLog() {
        // 日志内容
        // let body = $("#web_log").children("div").html("");
        // 从Div中提取文字内容
        let body = document.getElementById("web_log").innerText;
        // 定义下载的文件名
        let fileName = new Date().dateFormat("yyyy-MM-dd hh:mm:ss") + ".log";
        // 创建FileSystemObject对象
        // let fso = new ActiveXObject("Scripting.FileSystemObject");
        // // 创建文件
        // let logFile = fso.createtextfile(fileName, true);
        // // 填写数据，并增加换行符
        // logFile.WriteLine(body)
        // logFile.close()

        download(fileName, body);
    }

    if (!!window.EventSource) {
        // web logger sse监听 使用 SSE 时，浏览器首先生成一个EventSource实例，向服务器发起连接。 withCredentials属性，表示是否一起发送 Cookie
        var source = new EventSource("${ctxPath}/logger/constantly", {withCredentials: true});

        // EventSource实例的readyState属性，表明连接的当前状态。该属性只读，可以取以下值
        // 0：相当于常量EventSource.CONNECTING，表示连接还未建立，或者断线正在重连。
        // 1：相当于常量EventSource.OPEN，表示连接已经建立，可以接受数据。
        // 2：相当于常量EventSource.CLOSED，表示连接已断，且不会重连。
        console.log(source.readyState);

        // 连接一旦建立，就会触发open事件，可以在onopen属性定义回调函数
        source.onopen = function (event) {
            console.log("SSE建立连接");
        };

        // 客户端收到服务器发来的数据，就会触发message事件，可以在onmessage属性定义回调函数
        // 已经设置了textarea为readOnly,之所以没有设置为disabled是因为disabled不能复制,同时需要注意,接收的内容是需要追加到textarea中的
        source.onmessage = function (event) {
            console.log("SSE 服务端推送日志信息")
            console.log(event);
            let res = event.data
            console.log(typeof res);
            res = JSON.parse(res)
            let body = res['body']
            let timestamp = res['timestamp']
            let threadName = res['threadName']
            let className = res['className']
            let level = res['level']

            let log_html = '<div>'
            log_html += '<span class="log_span">' + timestamp + '</span>'
            if ("ERROR" == level) {
                log_html += '<span class="log_span level_error">' + level + '</span>'
            } else {
                log_html += '<span class="log_span level_debug">' + level + '</span>'
            }
            log_html += '<span class="log_span">[' + threadName + ']</span>'
            log_html += '<span class="log_span" style="color:#009688">' + className + '</span>'
            log_html += '<span class="log_span">：' + body + '</span></div>'
            log_html += '</div>'
            console.log(log_html);
            $("#web_log").children("div").append(log_html)
            // 设置 div 默认滑动到底部
            $('#web_log .log_container').scrollTop($('#web_log .log_container')[0].scrollHeight);

        };

        // 如果发生通信错误（比如连接中断），就会触发error事件，可以在onerror属性定义回调函数
        source.onerror = function (event) {
            console.log("SSE通信发生错误,默认会自动重连,如果不需要自动重连,需要手动close掉");
            console.log(event);
            source.close()
        };
    } else {
        // 浏览器不支持 Server-Sent..
        console.log("当前浏览器不支持Server-Sent Event");
    }


    /**
     * WebLog全屏显示
     */
    function logFullScreen() {
        console.log("WebLog全屏显示");
        let index = layer.open({
            type: 2,
            content: $('#web_log'),
            area: ['320px', '195px'],
            maxmin: true
        });
        layer.full(index);
    }
</script>